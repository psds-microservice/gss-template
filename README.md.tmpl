# {{.Project.K}}

Go service (GORM, PostgreSQL). Generated by [gss](https://github.com/psds-microservice/gss).

Генерация кода из `.proto`: используется репозиторий [psds-microservice/infra](https://github.com/psds-microservice/infra) — добавьте его как submodule в папку `infra/` (см. `infra/README.md`), затем `make proto`. Общие типы: [psds-microservice/helpy](https://github.com/psds-microservice/helpy).

## Setup

1. Copy `.env.example` to `.env` and set `DB_*`. При `APP_ENV=production` обязателен `DB_PASSWORD`.
2. При запуске команды `api` подгружается `.env` (godotenv). Конфиг валидируется при старте (`config.Validate()`): обязательны `DB_HOST`, `DB_USER`, `DB_DATABASE`; в production — `DB_PASSWORD`.
3. `make run` or `go run ./cmd/{{.Project.K}} api`.
4. Режимы: `api`, `worker`, `scheduler`, `seeder`, `command` (см. `make help`).

## Конфиг и окружение

- **APP_HOST** — адрес биндинга (по умолчанию `0.0.0.0`).
- **HTTP_PORT** — порт HTTP (по умолчанию `8080`).
- **APP_ENV** — `development` / `production`; в production конфиг требует `DB_PASSWORD`.
- Загрузка `.env`: при старте `api` вызывается `godotenv.Load(".env")` (ошибка игнорируется, если файла нет).

## API и shutdown

- HTTP-сервер создаётся с таймаутами: `ReadHeaderTimeout`, `ReadTimeout`, `WriteTimeout`, `IdleTimeout` — для защиты от зависших соединений.
- Graceful shutdown: по SIGINT/SIGTERM вызывается `Shutdown(ctx)` с контекстом 10 с.

## Proto и gRPC / grpc-gateway

- **Все сервисы разворачивают gRPC и grpc-gateway.** В шаблоне уже есть: `pkg/proto/api.proto` (один RPC Health с `google.api.http`), `third_party/google/api` (annotations.proto, http.proto), `internal/grpc/server.go` (скелет реализации), генерация в Makefile с `--grpc-gateway_out`. После генерации проекта выполните `make proto` — Go-код появится в `pkg/gen/proto/`. HTTP-сервер отдаёт `/health`, `/ready`, Swagger и проксирует `/api/v1/*` в grpc-gateway.
- **Расширение:** добавьте RPC и сообщения в `pkg/proto/api.proto` (или разбейте на несколько .proto), реализуйте методы в `internal/grpc` (и при необходимости разнесите по файлам server_*.go). Deps в grpc-сервере заполняйте интерфейсами из `internal/service`. Конфиг: `GRPC_PORT` (по умолчанию 9090).
- **Инфра:** для сборки образа protoc можно добавить [psds-microservice/infra](https://github.com/psds-microservice/infra) в `infra/` (submodule). Локально достаточно установить protoc, protoc-gen-go, protoc-gen-go-grpc, protoc-gen-grpc-gateway, protoc-gen-openapiv2 (см. `make help`).

## Валидация и ошибки

- **Валидация на входе:** вызывать валидатор (`internal/validator`) до вызова сервиса; при ошибке возвращать HTTP 400 или gRPC `codes.InvalidArgument` с понятным сообщением.
- **Маппинг ошибок:** доменные ошибки (sentinel в сервисе или в `internal/errors`) маппить в одном месте в HTTP-коды или gRPC `codes.*` (например `mapError` в gRPC-сервере). Для единообразия кодов ошибок между сервисами можно использовать [helpy/errors](https://github.com/psds-microservice/helpy/tree/main/errors): `errors.Code`, `errors.Error`, `errors.New(code, message)` — машинно-читаемые коды (INVALID_ARGUMENT, NOT_FOUND и т.д.) для контрактов по gRPC/HTTP. Подключение: `go get github.com/psds-microservice/helpy`.

## Migrations и сиды

- **SQL-миграции**: [golang-migrate](https://github.com/golang-migrate/migrate). Файлы в `database/migrations/` в формате `*_name.up.sql` и `*_name.down.sql`. Команды: `make migrate`, `make migrate-create`.
- **Сиды**: SQL-файлы в `database/seeds/` (по порядку имени). Команда: `make seed`. Полная инициализация: `make db-init` (migrate + seed).
- При запуске API автоматически выполняется `MigrateUp` и GORM AutoMigrate. При использовании только версионированных SQL-миграций AutoMigrate можно убрать или ограничить вспомогательными таблицами.

## Consumer / Worker

- `internal/consumer` и worker — заглушки. Реализовать обработку очередей (например RabbitMQ) или удалить пакет и описать в README.

## Константы путей

- Пути `/health`, `/ready`, `/swagger` заданы в `pkg/constants` и используются в application и handler.

## OpenAPI / Swagger

- **Swagger UI:** при запуске API доступен по адресу `http://localhost:8080/swagger/index.html`. Спека подгружается из `openapi.json` (относительно текущего пути или `api/`).
- **Спеку** можно положить вручную в `api/openapi.json` или `api/openapi.swagger.json`, либо сгенерировать из proto: добавьте `third_party/google/api` (annotations.proto, http.proto), опишите в `.proto` RPC с `google.api.http`, затем `make proto-openapi`. Результат появится в `api/`.
- Зависимости для генерации: `make install-deps` (в т.ч. `protoc-gen-openapiv2`).

## CI

- Версию Go в `.github/workflows` синхронизировать с `go.mod`.
